<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PJ Store | Professional Flutes</title>

    <link href="https://fonts.googleapis.com/css2?family=Great+Vibes&family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">

    <style>
        :root {
            --primary: #ff7a00;
            --accent: #ffe7b0;
            --dark: #000000;
            --card-bg: #111111;
        }

        body {
            margin: 0;
            background: var(--dark);
            color: var(--accent);
            font-family: 'Poppins', sans-serif;
            overflow-x: hidden;
            -webkit-tap-highlight-color: transparent;
        }

        button, a, input, div, span {
            outline: none;
        }

        .hidden { display: none !important; }

        /* WATERMARK BACKGROUND */
        .watermark-bg {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 80vw;
            height: 80vw;
            max-width: 600px;
            max-height: 600px;
            background: url('https://i.postimg.cc/3w76Yfc0/file-00000000f0cc71faab033f0116f53261.jpg') no-repeat center;
            background-size: contain;
            opacity: 0.1;
            z-index: -1;
            pointer-events: none;
        }

        /* TOP NAVIGATION */
        .top {
            position: fixed;
            top: 0;
            width: 100%;
            height: 70px;
            background: var(--primary);
            display: flex;
            align-items: center;
            padding: 0 20px;
            z-index: 999;
            box-sizing: border-box;
            box-shadow: 0 2px 10px rgba(0,0,0,0.3);
        }

        .logo { width: 45px; height: 45px; border-radius: 50%; border: 2px solid white; }
        .logoBox { display: flex; align-items: center; gap: 12px; }
        .logoBox span { font-size: 16px; font-weight: bold; color: white; letter-spacing: 1px; }

        .nav-right {
            margin-left: auto;
            display: flex;
            align-items: center;
            gap: 15px;
        }

        .cartIcon {
            display: flex;
            align-items: center;
            cursor: pointer;
            color: white;
            position: relative;
        }

        .ytIcon {
            width: 32px;
            height: 32px;
            cursor: pointer;
            display: block;
        }

        /* CONTENT */
        .content-wrapper { padding-top: 80px; padding-bottom: 40px; }

        .title { 
            text-align: center; 
            font-size: 65px; 
            font-family: 'Great Vibes', cursive; 
            margin: 20px 0 10px;
            color: var(--primary);
        }

        .heroTitle {
            text-align: center;
            font-size: 32px;
            font-family: "Great Vibes";
            margin-bottom: 10px;
        }

        /* PINCODE BOX UI */
        .pincodeBox {
            width: 90%;
            max-width: 500px;
            margin: 15px auto;
            display: flex;
            flex-direction: column;
            gap: 8px;
            background: rgba(255,122,0,0.05);
            padding: 15px;
            border-radius: 20px;
            border: 1px solid rgba(255,122,0,0.2);
            box-sizing: border-box;
        }
        .pincode-input-row {
            display: flex;
            gap: 10px;
        }
        .pincodeBox input {
            flex: 1;
            padding: 12px;
            border-radius: 12px;
            border: 1px solid #444;
            background: #222;
            color: white;
            font-size: 14px;
        }
        .pincodeBox button {
            padding: 12px 18px;
            border: none;
            border-radius: 12px;
            background: var(--primary);
            color: white;
            font-weight: bold;
            cursor: pointer;
        }
        #shipResult {
            font-size: 12px;
            color: #fff;
            text-align: center;
            min-height: 18px;
        }

        /* PREMIUM HERO SLIDER */
        .slider-container {
            width: 90%;
            margin: 20px auto;
            height: 250px;
            position: relative;
            border-radius: 25px;
            overflow: hidden;
            box-shadow: 0 15px 35px rgba(0,0,0,0.6);
            border: 1px solid rgba(255,122,0,0.3);
        }

        .slide {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            opacity: 0;
            transition: opacity 1.5s ease-in-out;
            background-size: cover;
            background-position: center;
        }

        .slide.active { opacity: 1; }

        /* PRODUCT IMAGE SLIDER ENGINE */
        .product-slider {
            position: relative;
            overflow: hidden;
            border-radius: 15px;
            background: #000;
        }

        .product-track {
            display: flex;
            transition: transform .5s cubic-bezier(.77,0,.18,1);
        }

        .product-track img {
            width: 100%;
            flex-shrink: 0;
            border-radius: 15px;
            cursor: pointer;
            display: block;
        }

        .arrow {
            position: absolute;
            top: 50%;
            transform: translateY(-50%);
            background: rgba(0,0,0,.6);
            color: white;
            border: none;
            width: 32px;
            height: 32px;
            border-radius: 50%;
            font-size: 20px;
            cursor: pointer;
            z-index: 5;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.3s;
        }
        .arrow:hover { background: var(--primary); }
        .arrow.left { left: 10px; }
        .arrow.right { right: 10px; }

        .dots {
            text-align: center;
            margin-top: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 6px;
        }

        .dot {
            display: inline-block;
            width: 8px;
            height: 8px;
            background: #555;
            border-radius: 50%;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            cursor: pointer;
        }

        .dot.active {
            width: 15px;
            height: 15px;
            background: var(--primary);
            box-shadow: 0 0 10px var(--primary);
        }

        /* FULLSCREEN VIEWER */
        .viewer {
            position: fixed;
            inset: 0;
            background: rgba(0,0,0,0.95);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 99999;
            cursor: zoom-out;
        }

        .viewer img {
            max-width: 95%;
            max-height: 95%;
            border-radius: 10px;
            box-shadow: 0 0 30px rgba(0,0,0,0.5);
        }

        /* 3D BUTTON */
        .shopBtn {
            display: block;
            margin: 35px auto;
            background: linear-gradient(to bottom, #ff9a2f, #ff7a00);
            color: white;
            border: none;
            padding: 18px 50px;
            border-radius: 40px;
            font-size: 22px;
            font-weight: bold;
            text-transform: uppercase;
            box-shadow: 0 8px 0 #c45c00, 0 15px 20px rgba(0,0,0,0.4);
            cursor: pointer;
            transition: all 0.1s;
        }

        .shopBtn:active {
            transform: translateY(6px);
            box-shadow: 0 2px 0 #c45c00;
        }

        /* SECTIONS */
        .info-section {
            width: 90%;
            margin: 30px auto;
            background: rgba(255,122,0,0.05);
            padding: 25px;
            border-radius: 25px;
            border: 1px solid rgba(255,122,0,0.2);
        }

        .info-section h2 {
            color: var(--primary);
            font-family: 'Great Vibes', cursive;
            font-size: 36px;
            text-align: center;
            margin-bottom: 20px;
        }

        .info-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .info-list li {
            font-size: 14px;
            margin-bottom: 12px;
            padding-left: 25px;
            position: relative;
            line-height: 1.6;
        }

        .info-list li::before {
            content: "‚Ä¢";
            color: var(--primary);
            position: absolute;
            left: 0;
            font-weight: bold;
            font-size: 20px;
        }

        .contact-container {
            display: flex;
            justify-content: center;
            align-items: center;
            gap: 8px;
            margin: 30px 10px;
            flex-wrap: wrap;
        }

        .btn-contact {
            background: var(--primary);
            color: white;
            padding: 12px 10px;
            border-radius: 30px;
            text-decoration: none;
            font-weight: 600;
            flex: 1;
            min-width: 100px;
            text-align: center;
            font-size: 13px;
            box-shadow: 0 4px 8px rgba(0,0,0,0.3);
            white-space: nowrap;
        }

        /* OVERLAYS */
        #shop, #cartPage {
            position: fixed; top: 0; left: 0; width: 100%; height: 100%;
            background: var(--dark); overflow-y: auto; padding: 90px 20px 100px;
            z-index: 10000; box-sizing: border-box;
        }

        .header { 
            position: fixed; top: 0; left: 0; width: 100%;
            background: #111; padding: 15px 20px; 
            display: flex; justify-content: space-between; align-items: center;
            border-bottom: 1px solid #333; z-index: 10001;
            box-sizing: border-box;
        }

        .search { 
            width: 100%; max-width: 500px; margin: 10px auto 30px; display: block;
            padding: 15px 20px; border-radius: 30px; border: 1px solid #444; 
            background: #222; color: white; box-sizing: border-box;
        }

        .list { display: grid; grid-template-columns: repeat(auto-fill, minmax(280px, 1fr)); gap: 30px; }

        .product { background: var(--card-bg); border-radius: 20px; padding: 20px; border: 1px solid #222; }

        .qty-box {
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 15px;
            margin: 10px 0;
        }
        .qty-btn {
            background: #333;
            color: var(--primary);
            border: 1px solid var(--primary);
            width: 32px;
            height: 32px;
            border-radius: 50%;
            cursor: pointer;
            font-weight: bold;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        .qty-num { font-weight: bold; font-size: 18px; min-width: 25px; text-align: center; color: white; }

        .buy {
            background: var(--primary); border: none; padding: 14px; width: 100%;
            margin-top: 10px; border-radius: 12px; color: white; font-weight: bold;
            cursor: pointer; font-size: 16px; box-shadow: 0 4px 0 #b95600;
        }

        .buy-alt { background: transparent; border: 1px solid var(--primary); color: var(--primary); box-shadow: none; }
        
        #cartCount {
            background: white; color: black; font-size: 11px; border-radius: 50%; 
            width: 20px; height: 20px; display: flex; align-items: center; 
            justify-content: center; font-weight: bold; position: absolute;
            top: -8px; right: -8px; border: 2px solid var(--primary);
        }

        /* TOAST NOTIFICATION */
        #toast {
            position: fixed;
            bottom: -100px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--primary);
            color: white;
            padding: 12px 25px;
            border-radius: 50px;
            font-weight: 600;
            box-shadow: 0 5px 20px rgba(0,0,0,0.5);
            z-index: 20000;
            transition: bottom 0.5s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            display: flex;
            align-items: center;
            gap: 10px;
            white-space: nowrap;
        }

        #toast.show { bottom: 30px; }

        .footer { text-align: center; padding: 40px 0; opacity: 0.7; font-size: 14px; }
    </style>
</head>
<body>

<div class="watermark-bg"></div>

<!-- Toast Box -->
<div id="toast">
    <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round"><polyline points="20 6 9 17 4 12"></polyline></svg>
    <span id="toastMsg">Added to Cart!</span>
</div>

<div class="top">
    <div class="logoBox">
        <img class="logo" src="https://i.postimg.cc/3w76Yfc0/file-00000000f0cc71faab033f0116f53261.jpg" alt="Logo">
        <span>PJ STORE</span>
    </div>
    <div class="nav-right">
        <a href="https://www.youtube.com/@PJCompany-432" target="_blank">
            <svg class="ytIcon" viewBox="0 0 24 24">
                <path fill="#FF0000" d="M23.498 6.186a3.016 3.016 0 0 0-2.122-2.136C19.505 3.545 12 3.545 12 3.545s-7.505 0-9.377.505A3.017 3.017 0 0 0 .502 6.186C0 8.07 0 12 0 12s0 3.93.502 5.814a3.016 3.016 0 0 0 2.122 2.136c1.871.505 9.376.505 9.376.505s7.505 0 9.377-.505a3.015 3.015 0 0 0 2.122-2.136C24 15.93 24 12 24 12s0-3.93-.502-5.814z"/>
                <path fill="#FFFFFF" d="M9.545 15.568V8.432L15.818 12l-6.273 3.568z"/>
            </svg>
        </a>
        <div class="cartIcon" onclick="openCart()">
            <svg width="28" height="28" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="9" cy="21" r="1"></circle>
                <circle cx="20" cy="21" r="1"></circle>
                <path d="M1 1h4l2.68 13.39a2 2 0 0 0 2 1.61h9.72a2 2 0 0 0 2-1.61L23 6H6"></path>
            </svg>
            <span id="cartCount">0</span>
        </div>
    </div>
</div>

<div id="home" class="content-wrapper">
    <div class="title">PJ Store</div>
    
    <div class="slider-container">
        <div class="slide active" style="background-image: url('https://i.postimg.cc/zXkJgfLD/IMG-20260218-194815-054.jpg');"></div>
        <div class="slide" style="background-image: url('https://i.postimg.cc/N0KYS7dg/IMG-20260218-194851-468-2.jpg');"></div>
    </div>

    <div class="heroTitle">PJ Classical Flute Shop</div>

    <!-- ADVANCED PINCODE BOX -->
    <div class="pincodeBox">
        <div class="pincode-input-row">
            <input id="userPincode" type="number" placeholder="Enter Delivery Pincode">
            <button onclick="checkShipping()">Check</button>
        </div>
        <div id="shipResult">Enter pincode to check delivery</div>
        <div style="font-size: 10px; opacity: 0.6; text-align: center; cursor: pointer; color: var(--primary)" onclick="getLocation()">Detect Live Location Instead</div>
    </div>

    <button class="shopBtn" onclick="openShop()">Shop Now</button>

    <div style="width: 90%; margin: 20px auto; border-radius: 25px; overflow: hidden; border: 1px solid rgba(255,122,0,0.2);">
        <img src="https://i.postimg.cc/sg32c8SP/Screenshot-20260219-102520-Instagram.png" style="width:100%; display:block;" alt="Instagram Banner">
    </div>

    <div class="info-section">
        <h2>Why Choose PJ Flutes</h2>
        <ul class="info-list">
            <li>Handcrafted with over 9 years of professional experience.</li>
            <li>Made from premium quality, seasoned Assam Bamboo.</li>
            <li>Each flute is manually tuned to perfection.</li>
            <li>Direct support from the maker himself.</li>
        </ul>
    </div>

    <div class="contact-container">
        <a href="https://wa.me/919476091829" target="_blank" class="btn-contact">WhatsApp</a>
        <a href="tel:9434274060" class="btn-contact">Call Us</a>
        <a href="mailto:pjcompanyofficial@gmail.com" class="btn-contact">Email Us</a>
    </div>
    <div class="footer">¬© 2026 PJ Store. Handcrafted Perfection.</div>
</div>

<!-- SHOP OVERLAY -->
<div id="shop" class="hidden">
    <div class="header">
        <div class="backIcon" onclick="closeShop()" style="cursor:pointer">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        </div>
        <div style="font-weight:bold; color: white;">Our Collection</div>
        <div style="width:32px"></div>
    </div>
    <input class="search" placeholder="Search by scale (e.g. C#)..." onkeyup="search(this.value)">
    <div class="list" id="list"></div>
</div>

<!-- CART OVERLAY -->
<div id="cartPage" class="hidden">
    <div class="header">
        <div class="backIcon" onclick="closeCart()" style="cursor:pointer">
            <svg width="32" height="32" viewBox="0 0 24 24" fill="none" stroke="white" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <line x1="19" y1="12" x2="5" y2="12"></line>
                <polyline points="12 19 5 12 12 5"></polyline>
            </svg>
        </div>
        <div style="font-weight:bold; color: white;">Your Cart</div>
        <div style="width:32px"></div>
    </div>
    <div id="cartItems"></div>
    <div style="background:#111; padding:20px; border-radius:20px; margin-top:20px; text-align:center">
        <p style="opacity:.7; font-size: 14px; margin-bottom: 5px;">Subtotal: ‚Çπ <span id="subtotalVal">0</span></p>
        <p style="opacity:.7; font-size: 14px; margin-bottom: 10px;">Shipping: ‚Çπ <span id="shipPrice">0</span></p>
        <h2 style="color:white; margin: 10px 0;">Total: ‚Çπ <span id="total">0</span></h2>
        <button class="shopBtn" onclick="sendOrder()">Confirm Order via WhatsApp</button>
    </div>
</div>

<script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
import { getAuth, signInAnonymously, onAuthStateChanged, signInWithCustomToken } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

const products = [
    { name:"E Middle Flute", price:1100, size:"40.64cm", imgs:["https://i.postimg.cc/502FG81g/1771519608780.jpg", "https://i.postimg.cc/s2wMp1SZ/IMG-20260219-221951301-HDR-2.jpg", "https://i.postimg.cc/vB45T5jn/IMG-20260219-221943546-HDR-2.jpg"] },
    { name:"D Middle Flute", price:1300, size:"72cm", imgs:["https://i.postimg.cc/FFqDyHgx/1771520179168.jpg", "https://i.postimg.cc/SRRX5b02/IMG-20260219-222754339-HDR-2.jpg", "https://i.postimg.cc/7YCGn4MK/IMG-20260219-222851920-HDR-2.jpg"] },
    { name:"C# Middle Flute", price:1470, size:"46.99cm", imgs:["https://i.postimg.cc/XJPcksFZ/1771520546004.jpg", "https://i.postimg.cc/YSxhCCMh/IMG-20260219-223337971-HDR-2.jpg", "https://i.postimg.cc/4yj3SKQR/IMG-20260219-223359439-HDR-3.jpg"] },
    { name:"C Middle Flute", price:1500, size:"49.53cm", imgs:["https://i.postimg.cc/Px0V5XSc/1771520843131.jpg", "https://i.postimg.cc/NjGDY2gT/IMG-20260219-223817682-HDR-2.jpg", "https://i.postimg.cc/L6ffMRYT/IMG-20260219-223823254-HDR-2.jpg"] },
    { name:"A# Base Flute", price:1600, size:"54.61cm", imgs:["https://i.postimg.cc/3RQD8zXM/1771521406435.jpg", "https://i.postimg.cc/9Q44Gcby/IMG-20260219-224734484-HDR-2.jpg", "https://i.postimg.cc/PJ3xw783/IMG-20260219-224743992-HDR-2.jpg"] },
    { name:"A Base Flute", price:1700, size:"59.69cm", imgs:["https://i.postimg.cc/HsnjgTfK/1771521704557.jpg", "https://i.postimg.cc/3x1kKwKd/IMG-20260219-225310152-HDR-2.jpg", "https://i.postimg.cc/9MR0ttyc/IMG-20260219-225316805-HDR-2.jpg"] },
    { name:"G# Base Flute", price:1850, size:"62.23cm", imgs:["https://i.postimg.cc/hvj4c03r/1771522139146.jpg", "https://i.postimg.cc/Pxgx6pM3/IMG-20260219-230013992-HDR-2.jpg", "https://i.postimg.cc/PfDNCyt3/IMG-20260219-230030866-HDR-2.jpg"] },
    { name:"G Base Flute", price:1800, size:"67.31CM", imgs:["https://i.postimg.cc/T38x4GGF/1771522508719.jpg", "https://i.postimg.cc/nLpJnkXR/IMG-20260219-234259235-HDR-2.jpg", "https://i.postimg.cc/7ZKZFQVT/IMG-20260219-234312866-HDR-2.jpg"] }
];

// --- CORE SHIPPING LOGIC ---
let shippingCharge = 0;
let userLocationDetails = "Not Specified";
const originPin = "744101"; // Port Blair

// Distance Helper
function getDistance(lat1, lon1, lat2, lon2){
    const R = 6371;
    const dLat = (lat2-lat1)*Math.PI/180;
    const dLon = (lon2-lon1)*Math.PI/180;
    const a =
        Math.sin(dLat/2)*Math.sin(dLat/2) +
        Math.cos(lat1*Math.PI/180)*Math.cos(lat2*Math.PI/180) *
        Math.sin(dLon/2)*Math.sin(dLon/2);
    return R * (2*Math.atan2(Math.sqrt(a), Math.sqrt(1-a)));
}

// Shipping Cost Calculator based on Distance
function calculateShipFromDist(dist) {
    if(dist < 50) return 50;        // Local Andaman
    if(dist < 800) return 120;      // Nearby (East India/Coast)
    if(dist < 1500) return 200;     // Mid Distance
    if(dist < 3000) return 300;     // Far (Delhi, North)
    return 400;                     // Extreme ends
}

// Check via Pincode Input
window.checkShipping = async () => {
    let userPin = document.getElementById("userPincode").value.trim();
    let result = document.getElementById("shipResult");

    if(userPin.length !== 6){
        result.innerText = "Enter valid 6-digit pincode";
        return;
    }

    result.innerText = "Calculating distance...";

    try {
        const geo = async pin => {
            let r = await fetch(`https://api.postalpincode.in/pincode/${pin}`);
            let d = await r.json();
            if(!d[0].PostOffice) throw new Error();
            // We'll use a simplified coordinate fetch or standard distance for pincodes
            // For true lat/lon for distance, we'd need a different API, but we'll simulate logic here
            // using the Pincode's State/Region mapping for Port Blair origin.
            return d[0].PostOffice[0];
        }

        let to = await geo(userPin);
        
        // Since free Pincode API doesn't give lat/lon, we use a region-based logic for Port Blair (Remote Origin)
        let state = to.State.toLowerCase();
        let charge = 120; // Default
        
        if(state.includes("andaman")) charge = 50;
        else if(state.includes("assam") || state.includes("bengal") || state.includes("odisha")) charge = 180;
        else if(state.includes("delhi") || state.includes("punjab") || state.includes("jammu")) charge = 350;
        else if(state.includes("kerala") || state.includes("tamil")) charge = 300;
        else charge = 250;

        shippingCharge = charge;
        userLocationDetails = `${to.District}, ${to.State} (${userPin})`;
        result.innerHTML = `üìç ${to.District} ‚Ä¢ Shipping: <b>‚Çπ${charge}</b>`;
        
        updateCartUI();
        renderShop(products); // Update shop price tags
    } catch(e) {
        result.innerText = "Invalid Pincode or Network Error";
    }
}

// Detect Live Location (Lat/Lon)
window.getLocation = () => {
    const box = document.getElementById("shipResult");
    box.innerText = "Detecting live location...";

    navigator.geolocation.getCurrentPosition(async pos => {
        let lat = pos.coords.latitude;
        let lon = pos.coords.longitude;

        try {
            // Port Blair approx: 11.6231¬∞ N, 92.7265¬∞ E
            let dist = getDistance(11.62, 92.72, lat, lon);
            
            let res = await fetch(`https://nominatim.openstreetmap.org/reverse?format=json&lat=${lat}&lon=${lon}`);
            let data = await res.json();
            let state = data.address.state || "";
            let city = data.address.city || data.address.town || "Your City";

            shippingCharge = calculateShipFromDist(dist);
            userLocationDetails = `${city}, ${state}`;

            box.innerHTML = `üìç ${city} ‚Ä¢ ${Math.round(dist)}km ‚Ä¢ Shipping: <b>‚Çπ${shippingCharge}</b>`;
            
            updateCartUI();
            renderShop(products);
        } catch(e) {
            box.innerText = "Error fetching address details.";
        }
    }, () => {
        box.innerText = "Location access denied.";
    });
};

// --- REST OF APP LOGIC ---

let currentUser = null;
let cart = [];
let shopQtys = {};
let sliderIndex = {};
let startX = 0;
const appId = typeof __app_id !== 'undefined' ? __app_id : 'pj-store-pwa';

const initFirebase = async () => {
    if (typeof __firebase_config === "undefined") return;
    try {
        const firebaseConfig = JSON.parse(__firebase_config);
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        if (typeof __initial_auth_token !== 'undefined' && __initial_auth_token) {
            await signInWithCustomToken(auth, __initial_auth_token);
        } else {
            await signInAnonymously(auth);
        }

        onAuthStateChanged(auth, (user) => {
            if (user) {
                currentUser = user;
                const cartRef = doc(db, 'artifacts', appId, 'users', user.uid, 'store', 'cart');
                onSnapshot(cartRef, (docSnap) => {
                    if (docSnap.exists()) {
                        cart = docSnap.data().items || [];
                        updateCartUI();
                    }
                });
            }
        });

        window.syncCart = async () => {
            if (!currentUser) return;
            const cartRef = doc(db, 'artifacts', appId, 'users', currentUser.uid, 'store', 'cart');
            await setDoc(cartRef, { items: cart });
        };
    } catch(e) { console.error(e); }
};
initFirebase();

window.showToast = (msg) => {
    const toast = document.getElementById("toast");
    const toastMsg = document.getElementById("toastMsg");
    toastMsg.innerText = msg;
    toast.classList.add("show");
    setTimeout(() => toast.classList.remove("show"), 2500);
};

window.slide = (id, dir) => {
    if (sliderIndex[id] === undefined) sliderIndex[id] = 0;
    const track = document.getElementById("track" + id);
    const total = track.children.length;
    sliderIndex[id] = (sliderIndex[id] + dir + total) % total;
    updateSliderUI(id);
};

window.goSlide = (id, i) => {
    sliderIndex[id] = i;
    updateSliderUI(id);
};

function updateSliderUI(id) {
    const track = document.getElementById("track" + id);
    const index = sliderIndex[id] || 0;
    track.style.transform = `translateX(-${index * 100}%)`;
    const dots = document.querySelectorAll(`[id^='dot${id}-']`);
    dots.forEach((d, i) => d.classList.toggle("active", i === index));
}

window.renderShop = (arr) => {
    const shopList = document.getElementById("list");
    if(!shopList) return;
    shopList.innerHTML = "";
    const activeShip = shippingCharge || 0;

    arr.forEach((p, pi) => {
        const pId = p.name.replace(/\s+/g, '');
        shopList.innerHTML += `
        <div class="product">
            <div class="product-slider">
                <button class="arrow left" onclick="slide(${pi},-1)">‚Äπ</button>
                <div class="product-track" id="track${pi}">
                    ${p.imgs.map(src => `<img src="${src}" loading="lazy">`).join("")}
                </div>
                <button class="arrow right" onclick="slide(${pi},1)">‚Ä∫</button>
            </div>
            <div class="dots">
                ${p.imgs.map((_, i) => `<span class="dot ${i==0?'active':''}" id="dot${pi}-${i}" onclick="goSlide(${pi},${i})"></span>`).join("")}
            </div>
            <h3 style="margin:10px 0 5px; color:var(--primary)">${p.name}</h3>
            <p style="font-size:12px; opacity:0.7">Size: ${p.size}</p>
            <div style="font-size:20px; font-weight:bold; color: white;">‚Çπ ${p.price}</div>
            <div style="font-size:12px; color:#888;">Delivery: ‚Çπ ${activeShip || '--'}</div>
            
            <div class="qty-box">
                <button class="qty-btn" onclick="updateShopQty('${p.name}', -1)">-</button>
                <span class="qty-num" id="sqty-${pId}">1</span>
                <button class="qty-btn" onclick="updateShopQty('${p.name}', 1)">+</button>
            </div>
            <button class="buy buy-alt" onclick="addCart('${p.name}')">Add to Cart</button>
            <button class="buy" onclick="buyNow('${p.name}')">Buy Now</button>
        </div>`;
    });
};

window.updateShopQty = (name, delta) => {
    shopQtys[name] = Math.max(1, (shopQtys[name] || 1) + delta);
    const el = document.getElementById(`sqty-${name.replace(/\s+/g, '')}`);
    if(el) el.innerText = shopQtys[name];
};

window.addCart = (name) => {
    let p = products.find(x => x.name === name);
    let qty = shopQtys[name] || 1;
    let idx = cart.findIndex(x => x.name === name);
    if(idx > -1) cart[idx].qty += qty;
    else cart.push({name: p.name, price: p.price, img: p.imgs[0], qty: qty});
    
    window.showToast(`${p.name} added!`);
    shopQtys[name] = 1;
    document.getElementById(`sqty-${name.replace(/\s+/g, '')}`).innerText = 1;
    if(window.syncCart) window.syncCart(); else updateCartUI();
};

window.buyNow = (name) => {
    let p = products.find(x => x.name === name);
    let q = shopQtys[name] || 1;
    let ship = shippingCharge || 120;
    let msg = `Buying: ${p.name} (x${q})\nProduct: ‚Çπ${p.price*q}\nShipping: ‚Çπ${ship}\nTotal: ‚Çπ${(p.price*q)+ship}\nLocation: ${userLocationDetails}`;
    window.open("https://wa.me/919476091829?text=" + encodeURIComponent(msg), "_blank");
};

function updateCartUI() {
    const count = cart.reduce((t, i) => t + i.qty, 0);
    if(document.getElementById("cartCount")) document.getElementById("cartCount").innerText = count;
    renderCart();
}

function renderCart() {
    const cartDiv = document.getElementById("cartItems");
    if(!cartDiv) return;

    let subtotal = cart.reduce((t, i) => t + (i.price * i.qty), 0);
    let finalTotal = subtotal + (cart.length ? shippingCharge : 0);

    cartDiv.innerHTML = cart.length ? "" : '<div style="text-align:center; padding:50px; opacity:0.5; color: white;">Empty Cart</div>';
    cart.forEach((p, i) => {
        cartDiv.innerHTML += `
        <div class="product" style="margin-bottom:10px; display:flex; gap:15px; align-items:center;">
            <img src="${p.img}" style="width:50px; height:50px; object-fit:cover; border-radius:8px;">
            <div style="flex-grow:1">
                <h4 style="margin:0; color: white; font-size:14px;">${p.name}</h4>
                <div style="color:var(--primary); font-size:12px;">‚Çπ${p.price} x ${p.qty}</div>
            </div>
            <span style="color:red; cursor:pointer; padding:5px;" onclick="removeItem(${i})">‚úï</span>
        </div>`;
    });

    document.getElementById("subtotalVal").innerText = subtotal;
    document.getElementById("shipPrice").innerText = cart.length ? shippingCharge : 0;
    document.getElementById("total").innerText = finalTotal;
}

window.removeItem = (i) => {
    cart.splice(i, 1);
    if(window.syncCart) window.syncCart(); else updateCartUI();
};

window.sendOrder = () => {
    if(!cart.length) return;
    let subtotal = cart.reduce((t, i) => t + i.price * i.qty, 0);
    let msg = "New Order:\n" + cart.map(p => `- ${p.name} (x${p.qty})`).join("\n");
    msg += `\n\nSubtotal: ‚Çπ${subtotal}\nShipping: ‚Çπ${shippingCharge}\nTotal: ‚Çπ${subtotal+shippingCharge}\nLocation: ${userLocationDetails}`;
    window.open("https://wa.me/919476091829?text=" + encodeURIComponent(msg), "_blank");
};

window.openShop = () => { document.getElementById("home").classList.add("hidden"); document.getElementById("shop").classList.remove("hidden"); renderShop(products); };
window.closeShop = () => { document.getElementById("shop").classList.add("hidden"); document.getElementById("home").classList.remove("hidden"); };
window.openCart = () => { document.getElementById("cartPage").classList.remove("hidden"); updateCartUI(); };
window.closeCart = () => { document.getElementById("cartPage").classList.add("hidden"); };
window.search = (v) => renderShop(products.filter(p => p.name.toLowerCase().includes(v.toLowerCase())));

let heroIdx = 0;
setInterval(() => {
    const slides = document.querySelectorAll('.slide');
    if(slides.length < 2) return;
    slides[heroIdx].classList.remove('active');
    heroIdx = (heroIdx + 1) % slides.length;
    slides[heroIdx].classList.add('active');
}, 6000);
</script>

</body>
</html>
