<script>
let currentUser=null;
let cart=[];
let dbEnabled=false;

/* ---------- SAFE FIREBASE LOAD ---------- */
(async()=>{
try{
if(typeof __firebase_config!=="undefined"){
const { initializeApp } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js");
const { getAuth, signInAnonymously, onAuthStateChanged } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js");
const { getFirestore, doc, setDoc, onSnapshot } = await import("https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js");

const app=initializeApp(JSON.parse(__firebase_config));
const auth=getAuth(app);
const db=getFirestore(app);
const appId=typeof __app_id!=="undefined"?__app_id:"default";

dbEnabled=true;

signInAnonymously(auth);
onAuthStateChanged(auth,user=>{
if(!user)return;
currentUser=user;

const ref=doc(db,'artifacts',appId,'users',user.uid,'store','cart');
onSnapshot(ref,snap=>{
if(snap.exists()){
cart=snap.data().items||[];
updateCartIcon();
if(!document.getElementById("cartPage").classList.contains("hidden"))
renderCart();
}
});
});
window.syncCart=async()=>{
if(!dbEnabled||!currentUser)return;
const ref=doc(db,'artifacts',appId,'users',currentUser.uid,'store','cart');
await setDoc(ref,{items:cart});
};
}
}catch(e){console.log("Firebase disabled mode");}
})();

if(!window.syncCart){
window.syncCart=()=>{};
}

/* ---------- PRODUCTS ---------- */
const products=[
{name:"E Middle Flute",price:1100,size:"41cm",img:"https://i.postimg.cc/PJDKmt83/IMG-20260218-153859-964.webp"},
{name:"D Middle Flute",price:1300,size:"45.5cm",img:"https://i.postimg.cc/02TxJJnR/Screenshot-20260218-203603-Google.png"},
{name:"C# Middle Flute",price:1470,size:"46.3cm",img:"https://i.postimg.cc/QMrD5t9Y/Screenshot-20260218-154446-Google.jpg"},
{name:"C Middle Flute",price:1500,size:"50cm",img:"https://i.postimg.cc/mZFGdCYd/Screenshot-20260218-154844-Google.png"},
{name:"A# Base Flute",price:1200,size:"56.5cm",img:"https://i.postimg.cc/nVK3cLZy/Screenshot-20260218-155124-Google.png"},
{name:"G# Base Flute",price:1200,size:"60cm",img:"https://i.postimg.cc/7YGbn56K/1771410309328.jpg"},
{name:"G Base Flute",price:1800,size:"65.7cm",img:"https://i.postimg.cc/BnC8XdtD/Screenshot-20260218-155724-Google.png"}
];

/* ---------- SLIDER ---------- */
let currentSlide=0;
const slides=document.querySelectorAll('.slide');
setInterval(()=>{
slides[currentSlide].classList.remove('active');
currentSlide=(currentSlide+1)%slides.length;
slides[currentSlide].classList.add('active');
},10000);

/* ---------- CART FUNCTIONS ---------- */
window.addCart=name=>{
let p=products.find(x=>x.name===name);
let item=cart.find(x=>x.name===name);
if(item)item.qty++;
else cart.push({...p,qty:1});
syncCart();
updateCartIcon();
};

window.removeItem=i=>{
cart.splice(i,1);
syncCart();
renderCart();
updateCartIcon();
};

window.incQty=i=>{
cart[i].qty++;
syncCart();
renderCart();
updateCartIcon();
};

window.decQty=i=>{
if(cart[i].qty>1) cart[i].qty--;
syncCart();
renderCart();
updateCartIcon();
};

function updateCartIcon(){
document.getElementById("cartCount").innerText=
cart.reduce((t,i)=>t+i.qty,0);
}

/* ---------- RENDER SHOP ---------- */
window.render=arr=>{
const list=document.getElementById("list");
list.innerHTML="";
arr.forEach(p=>{
list.innerHTML+=`
<div class="product">
<img src="${p.img}">
<h3 style="margin:0;color:var(--primary)">${p.name}</h3>
<p style="font-size:13px;opacity:.7">Size: ${p.size}</p>
<div style="font-size:20px;font-weight:bold;margin:10px 0">₹ ${p.price}</div>
<button class="buy buy-alt" onclick="addCart('${p.name}')">Add to Cart</button>
<button class="buy" onclick="buyNow('${p.name}')">Buy Now</button>
</div>`;
});
};

/* ---------- NAVIGATION ---------- */
window.openShop=()=>{
home.classList.add("hidden");
shop.classList.remove("hidden");
cartPage.classList.add("hidden");
render(products);
};
window.closeShop=()=>shop.classList.add("hidden");
window.openCart=()=>{
cartPage.classList.remove("hidden");
renderCart();
};
window.closeCart=()=>cartPage.classList.add("hidden");
window.search=v=>render(products.filter(p=>p.name.toLowerCase().includes(v.toLowerCase())));

/* ---------- BUY NOW ---------- */
window.buyNow=name=>{
let p=products.find(x=>x.name===name);
let msg=`Hello PJ Store! I want to buy:\nProduct: ${p.name}\nPrice: ₹ ${p.price}`;
window.open("https://wa.me/919476091829?text="+encodeURIComponent(msg));
};

/* ---------- RENDER CART ---------- */
function renderCart(){
const div=document.getElementById("cartItems");
const controls=document.getElementById("orderControls");
let total=0;

if(!cart.length){
div.innerHTML=`<div style="text-align:center;padding:60px;color:white">
<p>Your cart is empty</p>
<button class="shopBtn smallShopBtn" onclick="openShop()">Go to Shop</button>
</div>`;
controls.style.display="none";
return;
}

controls.style.display="block";
div.innerHTML="";
cart.forEach((p,i)=>{
total+=p.price*p.qty;
div.innerHTML+=`
<div class="product" style="display:flex;gap:15px;align-items:center">
<img src="${p.img}" style="width:60px;height:60px;border-radius:10px">
<div style="flex:1">
<h4 style="margin:0">${p.name}</h4>
<div style="color:var(--primary)">₹ ${p.price}</div>
<div style="margin-top:6px">
<button onclick="decQty(${i})">−</button>
<b style="margin:0 10px">${p.qty}</b>
<button onclick="incQty(${i})">+</button>
</div>
</div>
<span style="color:red;cursor:pointer;font-size:18px" onclick="removeItem(${i})">✕</span>
</div>`;
});
document.getElementById("total").innerText=total;
}

/* ---------- SEND ORDER ---------- */
window.sendOrder=()=>{
if(!cart.length)return;
let msg="New Order:%0A";
cart.forEach(p=>msg+=`- ${p.name} x${p.qty}%0A`);
msg+=`Total ₹ ${document.getElementById("total").innerText}`;
window.open("https://wa.me/919476091829?text="+msg);
};
</script>
